name: Test lua-resty-digest-auth

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: Lint with StyLua
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: JohnnyMorganz/stylua-action@479972f01e665acfcba96ada452c36608bdbbb5e # v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: latest
          args: --check lib/

  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3
    
    - name: Build and test with Docker
      run: |
        cd test
        docker compose up --build -d
        sleep 15  # Wait for services to start
        
        # Wait for the test client to complete its tests
        echo "Waiting for test client to complete..."
        docker logs digest-auth-test-client
        
        # Check if test client completed successfully
        docker wait digest-auth-test-client
        CLIENT_EXIT_CODE=$(docker inspect digest-auth-test-client --format='{{.State.ExitCode}}')
        if [ "$CLIENT_EXIT_CODE" != "0" ]; then
          echo "Test client failed with exit code: $CLIENT_EXIT_CODE"
          docker logs digest-auth-test-client
          exit 1
        fi
        
        # Run additional exhaustive tests
        docker cp exhaustive_auth_test.sh lua-resty-digest-auth-test:/tmp/
        docker exec lua-resty-digest-auth-test bash -c 'chmod +x /tmp/exhaustive_auth_test.sh && /tmp/exhaustive_auth_test.sh'

        # Run advanced tests
        echo "Running advanced tests..."
        docker cp advanced_test.sh lua-resty-digest-auth-test:/tmp/
        docker exec lua-resty-digest-auth-test bash -c 'chmod +x /tmp/advanced_test.sh && /tmp/advanced_test.sh'

        # Run memory management tests
        echo "Running memory management tests..."
        docker cp memory_management_test.sh lua-resty-digest-auth-test:/tmp/
        docker exec lua-resty-digest-auth-test bash -c 'chmod +x /tmp/memory_management_test.sh && /tmp/memory_management_test.sh'

        # Run brute force protection tests
        echo "Running brute force protection tests..."
        docker cp brute_force_test.sh lua-resty-digest-auth-test:/tmp/
        docker exec lua-resty-digest-auth-test bash -c 'chmod +x /tmp/brute_force_test.sh && /tmp/brute_force_test.sh'
        
        # Performance tests
        echo "Running performance tests..."
        docker exec lua-resty-digest-auth-test bash -c '
          # Test concurrent requests
          for i in {1..10}; do
            curl -s --digest -u "alice:password123" http://localhost:8080/protected/ > /dev/null &
          done
          wait

          # Test rate limiting
          for i in {1..15}; do
            curl -s --digest -u "alice:wrongpass" http://localhost:8080/protected/ > /dev/null
          done
        '
        
        # Check logs for errors
        docker exec lua-resty-digest-auth-test tail -n 100 /usr/local/openresty/nginx/logs/error.log
        
        # Cleanup
        docker compose down
    
    - name: Test module loading
      run: |
        cd test
        docker compose up --build -d
        sleep 5
        
        # Test if module can be required
        docker exec lua-resty-digest-auth-test bash -c '
          /usr/local/openresty/bin/openresty -t
          echo "Nginx config test passed"
        '
        
        docker compose down
    
    - name: Security tests
      run: |
        cd test
        docker compose up --build -d
        sleep 5
        
        # Test brute force protection
        echo "Testing brute force protection..."
        docker exec lua-resty-digest-auth-test bash -c '
          # Try common passwords
          for pass in password 123456 admin root test; do
            curl -s --digest -u "alice:$pass" http://localhost:8080/protected/ > /dev/null
          done

          # Try empty credentials
          curl -s --digest -u ":" http://localhost:8080/protected/ > /dev/null

          # Try malformed auth headers
          curl -s -H "Authorization: Basic invalid" http://localhost:8080/protected/ > /dev/null
          curl -s -H "Authorization: Digest invalid" http://localhost:8080/protected/ > /dev/null
        '
        
        docker compose down

  test-alpine:
    name: Test on Alpine Linux
    runs-on: ubuntu-latest
    container:
      image: openresty/openresty:alpine-slim

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install dependencies
      run: |
        apk add --no-cache curl bash

    - name: Setup test environment
      run: |
        mkdir -p /usr/local/openresty/nginx/logs
        mkdir -p /usr/local/openresty/lualib/resty
        mkdir -p /etc/nginx

        cp lib/resty/digest_auth.lua /usr/local/openresty/lualib/resty/

        cat > /etc/nginx/htdigest << 'EOF'
        alice:Test Realm:49e8d18599d46ed533eb6f4ca0325170
        bob:Test Realm:357db14c909f66b39af570a770703768
        admin:Test Realm:812262381af0c3906de59b610343dfdf
        EOF

    - name: Copy test configuration
      run: |
        cp test/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

    - name: Run Alpine tests
      run: |
        # test nginx config
        /usr/local/openresty/bin/openresty -t

        # start nginx
        /usr/local/openresty/bin/openresty
        sleep 3

        echo "testing on alpine linux..."

        # test public endpoint
        PUBLIC_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)
        echo "public: $PUBLIC_CODE"

        # test protected without auth
        PROTECTED_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/protected/)
        echo "protected (no auth): $PROTECTED_CODE"

        # test with digest auth
        AUTH_CODE=$(curl -s -o /dev/null -w "%{http_code}" --digest -u "alice:password123" http://localhost:8080/protected/)
        echo "protected (digest auth): $AUTH_CODE"

        # verify results
        if [ "$PUBLIC_CODE" != "200" ]; then
          echo "❌ public endpoint failed: expected 200, got $PUBLIC_CODE"
          exit 1
        fi

        if [ "$PROTECTED_CODE" != "401" ]; then
          echo "❌ protected endpoint without auth failed: expected 401, got $PROTECTED_CODE"
          exit 1
        fi

        if [ "$AUTH_CODE" != "200" ]; then
          echo "❌ protected endpoint with digest auth failed: expected 200, got $AUTH_CODE"
          tail -n 30 /usr/local/openresty/nginx/logs/error.log
          exit 1
        fi

        echo "✅ alpine linux tests passed!"

        # stop nginx
        /usr/local/openresty/bin/openresty -s stop || true 
