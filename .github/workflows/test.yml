name: Test lua-resty-digest-auth

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and test with Docker
      run: |
        cd test
        docker compose up --build -d
        sleep 15  # Wait for services to start
        
        # Wait for the test client to complete its tests
        echo "Waiting for test client to complete..."
        docker logs digest-auth-test-client
        
        # Check if test client completed successfully
        docker wait digest-auth-test-client
        CLIENT_EXIT_CODE=$(docker inspect digest-auth-test-client --format='{{.State.ExitCode}}')
        if [ "$CLIENT_EXIT_CODE" != "0" ]; then
          echo "Test client failed with exit code: $CLIENT_EXIT_CODE"
          docker logs digest-auth-test-client
          exit 1
        fi
        
        # Run additional exhaustive tests
        docker cp test_digest_auth_exhaustive.sh lua-resty-digest-auth-test:/tmp/
        docker exec lua-resty-digest-auth-test bash -c 'chmod +x /tmp/test_digest_auth_exhaustive.sh && /tmp/test_digest_auth_exhaustive.sh'
        
        # Performance tests
        echo "Running performance tests..."
        docker exec lua-resty-digest-auth-test bash -c '
          # Test concurrent requests
          for i in {1..10}; do
            curl -s -u "alice:password123" http://localhost:8080/protected/ > /dev/null &
          done
          wait
          
          # Test rate limiting
          for i in {1..15}; do
            curl -s -u "alice:wrongpass" http://localhost:8080/protected/ > /dev/null
          done
        '
        
        # Check logs for errors
        docker exec lua-resty-digest-auth-test tail -n 100 /usr/local/openresty/nginx/logs/error.log
        
        # Cleanup
        docker compose down
    
    - name: Test module loading
      run: |
        cd test
        docker compose up --build -d
        sleep 5
        
        # Test if module can be required
        docker exec lua-resty-digest-auth-test bash -c '
          /usr/local/openresty/bin/openresty -t
          echo "Nginx config test passed"
        '
        
        docker compose down
    
    - name: Security tests
      run: |
        cd test
        docker compose up --build -d
        sleep 5
        
        # Test brute force protection
        echo "Testing brute force protection..."
        docker exec lua-resty-digest-auth-test bash -c '
          # Try common passwords
          for pass in password 123456 admin root test; do
            curl -s -u "alice:$pass" http://localhost:8080/protected/ > /dev/null
          done
          
          # Try empty credentials
          curl -s -u ":" http://localhost:8080/protected/ > /dev/null
          
          # Try malformed auth headers
          curl -s -H "Authorization: Basic invalid" http://localhost:8080/protected/ > /dev/null
          curl -s -H "Authorization: Digest invalid" http://localhost:8080/protected/ > /dev/null
        '
        
        docker compose down

  test-centos:
    runs-on: ubuntu-latest
    container: rockylinux:9

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        dnf update -y
        # Remove curl-minimal to avoid conflicts with full curl package
        dnf remove -y curl-minimal || true
        dnf install -y --allowerasing wget curl gcc make pcre-devel openssl-devel zlib-devel

    - name: Install OpenResty
      run: |
        dnf install -y dnf-utils
        dnf config-manager --add-repo https://openresty.org/package/centos/openresty.repo
        # Disable GPG check for OpenResty packages to avoid SHA1 hash algorithm issues
        dnf install -y --nogpgcheck openresty

    - name: Setup test environment
      run: |
        mkdir -p /usr/local/openresty/nginx/logs
        mkdir -p /usr/local/openresty/nginx/html
        mkdir -p /usr/local/openresty/lualib/resty
        mkdir -p /etc/nginx
        cp lib/resty/digest_auth.lua /usr/local/openresty/lualib/resty/
        
        cat > /tmp/htdigest << 'EOF'
        alice:Test Realm:5f4dcc3b5aa765d61d8327deb882cf99
        bob:Test Realm:7c4a8d09ca3762af61e59520943dc26494f8941b
        admin:Admin Area:21232f297a57a5a743894a0e4a801fc3
        EOF
        cp /tmp/htdigest /etc/nginx/htdigest

    - name: Create test configuration
      run: |
        cat > /tmp/nginx.conf << 'EOF'
        user root;
        worker_processes auto;
        pid /usr/local/openresty/nginx/logs/nginx.pid;

        events {
            worker_connections 1024;
        }

        http {
            include /usr/local/openresty/nginx/conf/mime.types;
            default_type application/octet-stream;

            access_log /usr/local/openresty/nginx/logs/access.log;
            error_log /usr/local/openresty/nginx/logs/error.log;

            sendfile on;
            tcp_nopush on;
            tcp_nodelay on;
            keepalive_timeout 65;

            lua_shared_dict digest_auth 2m;
            lua_shared_dict digest_auth_ratelimit 1m;

            init_by_lua_block {
                local DigestAuth = require "resty.digest_auth"
                local ok, err = DigestAuth.configure {
                    shared_memory_name = "digest_auth",
                    credentials_file = "/etc/nginx/htdigest",
                    realm = "Test Realm"
                }
                if not ok then
                    error("Failed to configure digest auth: " .. (err or "unknown error"))
                end
            }

            server {
                listen 8080;
                server_name localhost;
                
                location / {
                    return 200 "Public content\n";
                }
                
                location /protected/ {
                    access_by_lua_block {
                        local DigestAuth = require "resty.digest_auth"
                        DigestAuth.require_auth()
                    }
                    return 200 "Protected content\n";
                }
                
                location /health {
                    return 200 "OK\n";
                }
            }
        }
        EOF
        cp /tmp/nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

    - name: Run Rocky Linux tests
      run: |
        # Start nginx
        /usr/local/openresty/bin/openresty -p /usr/local/openresty/nginx -c /usr/local/openresty/nginx/conf/nginx.conf
        sleep 2
        
        echo "Testing on Rocky Linux 9..."
        curl -s -o /dev/null -w "Public: %{http_code}\n" http://localhost:8080/
        curl -s -o /dev/null -w "Protected: %{http_code}\n" http://localhost:8080/protected/
        curl -s -o /dev/null -w "Auth: %{http_code}\n" -u "alice:password123" http://localhost:8080/protected/
        
        # Verify responses
        [ "$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)" = "200" ] || exit 1
        [ "$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/protected/)" = "401" ] || exit 1
        [ "$(curl -s -o /dev/null -w "%{http_code}" -u "alice:password123" http://localhost:8080/protected/)" = "200" ] || exit 1
        
        echo "âœ… Rocky Linux 9 tests passed!"
        
        # Stop nginx gracefully
        /usr/local/openresty/bin/openresty -p /usr/local/openresty/nginx -c /usr/local/openresty/nginx/conf/nginx.conf -s stop || true 